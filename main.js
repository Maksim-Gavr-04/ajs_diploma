(()=>{"use strict";class e{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]}bindToDOM(e){if(!(e instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=e}drawUi(e){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",(e=>this.onNewGameClick(e))),this.saveGameEl.addEventListener("click",(e=>this.onSaveGameClick(e))),this.loadGameEl.addEventListener("click",(e=>this.onLoadGameClick(e))),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(e);for(let e=0;e<this.boardSize**2;e+=1){const a=document.createElement("div");a.classList.add("cell","map-tile","map-tile-"+(t=e,s=this.boardSize,0===t?"top-left":t===s-1?"top-right":t<s-1?"top":t===(s-1)*s?"bottom-left":t===s*s-1?"bottom-right":t>(s-1)*s?"bottom":t%s==0?"left":(t+1)%s==0?"right":"center")),a.addEventListener("mouseenter",(e=>this.onCellEnter(e))),a.addEventListener("mouseleave",(e=>this.onCellLeave(e))),a.addEventListener("click",(e=>this.onCellClick(e))),this.boardEl.appendChild(a)}var t,s;this.cells=Array.from(this.boardEl.children)}redrawPositions(e){for(const e of this.cells)e.innerHTML="";for(const s of e){const e=this.boardEl.children[s.position],a=document.createElement("div");a.classList.add("character",s.character.type);const i=document.createElement("div");i.classList.add("health-level");const l=document.createElement("div");l.classList.add("health-level-indicator","health-level-indicator-"+((t=s.character.health)<15?"critical":t<50?"normal":"high")),l.style.width=`${s.character.health}%`,i.appendChild(l),a.appendChild(i),e.appendChild(a)}var t}addCellEnterListener(e){this.cellEnterListeners.push(e)}addCellLeaveListener(e){this.cellLeaveListeners.push(e)}addCellClickListener(e){this.cellClickListeners.push(e)}addNewGameListener(e){this.newGameListeners.push(e)}addSaveGameListener(e){this.saveGameListeners.push(e)}addLoadGameListener(e){this.loadGameListeners.push(e)}onCellEnter(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellEnterListeners.forEach((e=>e.call(null,t)))}onCellLeave(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellLeaveListeners.forEach((e=>e.call(null,t)))}onCellClick(e){const t=this.cells.indexOf(e.currentTarget);this.cellClickListeners.forEach((e=>e.call(null,t)))}onNewGameClick(e){e.preventDefault(),this.newGameListeners.forEach((e=>e.call(null)))}onSaveGameClick(e){e.preventDefault(),this.saveGameListeners.forEach((e=>e.call(null)))}onLoadGameClick(e){e.preventDefault(),this.loadGameListeners.forEach((e=>e.call(null)))}static showError(e){alert(e)}static showMessage(e){alert(e)}selectCell(e,t="yellow"){this.deselectCell(e),this.cells[e].classList.add("selected",`selected-${t}`)}deselectCell(e){const t=this.cells[e];t.classList.remove(...Array.from(t.classList).filter((e=>e.startsWith("selected"))))}showCellTooltip(e,t){this.cells[t].title=e}hideCellTooltip(e){this.cells[e].title=""}showDamage(e,t){return new Promise((s=>{const a=this.cells[e],i=document.createElement("span");i.textContent=t,i.classList.add("damage"),a.appendChild(i),i.addEventListener("animationend",(()=>{a.removeChild(i),s()}))}))}setCursor(e){this.boardEl.style.cursor=e}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}}class t{constructor(e){if(this.level=e,this.attack=0,this.defence=0,this.health=50,"Character"===new.target.name)throw new Error("Creating instances of the `Character` class is prohibited")}levelUp(){this.level++,this.attack=Math.trunc(Math.max(this.attack,this.attack*(80+this.health)/100)),this.defence=Math.trunc(Math.max(this.defence,this.defence*(80+this.health)/100)),this.health+=80,this.health>100&&(this.health=100)}}class s extends t{constructor(e){super(e),this.attack=25,this.defence=25,this.health=100,this.movementDistance=2,this.attackDistance=2,this.type="bowman"}}class a extends t{constructor(e){super(e),this.attack=40,this.defence=10,this.health=100,this.movementDistance=4,this.attackDistance=1,this.type="swordsman"}}class i extends t{constructor(e){super(e),this.attack=10,this.defence=40,this.health=100,this.movementDistance=1,this.attackDistance=4,this.type="magician"}}class l extends t{constructor(e){super(e),this.attack=25,this.defence=25,this.health=100,this.movementDistance=2,this.attackDistance=2,this.type="vampire"}}class n extends t{constructor(e){super(e),this.attack=40,this.defence=10,this.health=100,this.movementDistance=4,this.attackDistance=1,this.type="undead"}}class o extends t{constructor(e){super(e),this.attack=10,this.defence=10,this.health=100,this.movementDistance=1,this.attackDistance=4,this.type="daemon"}}class h{constructor(){this.level=1,this.selectedCell=null,this.maxPoints=0}static from(e){return"object"==typeof e?e:null}}class r{constructor(e,s){if(!(e instanceof t))throw new Error("Character must be instance of Character or its children");if("number"!=typeof s)throw new Error("Position must be a number");this.character=e,this.position=s}}class c{constructor(){this.members=new Set}add(e){this.members.add(e)}toArray(){return[...this.members]}}function p(e,t,s){const a=new c,i=function*(e,t){for(;;){const s=e[Math.floor(Math.random()*e.length)],a=Math.floor(Math.random()*t)+1;yield new s(a)}}(e,t);for(let e=0;e<s;e++){const e=i.next().value;a.add(e)}return a.toArray()}const m="auto",d="pointer",C="crosshair",u="not-allowed",f={1:"prairie",2:"desert",3:"arctic",4:"mountain"},y=new e;y.bindToDOM(document.querySelector("#game-container"));const g=new class{constructor(e){this.storage=e}save(e){this.storage.setItem("state",JSON.stringify(e))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(e){throw new Error("Invalid state")}}}(localStorage),v=new class{constructor(e,t){this.gamePlay=e,this.gameState=new h,this.stateService=t,this.isBoardBlocked=!1,this.pointsStatistics=[],this.playersTypes=[s],this.opponentsTypes=[s],this.playersTeam=p(this.playersTypes,1,2),this.opponentsTeam=p(this.opponentsTypes,1,2),this.positionsOfPlayersTeam=this.teamPositioning(this.playersTeam,this.playersInitialCellIndexes()),this.positionsOfOpponentsTeam=this.teamPositioning(this.opponentsTeam,this.opponentsInitialCellIndexes())}init(){this.gamePlay.drawUi(f[this.gameState.level]),this.gamePlay.redrawPositions([...this.positionsOfPlayersTeam,...this.positionsOfOpponentsTeam]),this.gamePlay.addCellClickListener(this.onCellClick.bind(this)),this.gamePlay.addCellEnterListener(this.onCellEnter.bind(this)),this.gamePlay.addCellLeaveListener(this.onCellLeave.bind(this)),this.gamePlay.addNewGameListener(this.onNewGameClick.bind(this)),this.gamePlay.addSaveGameListener(this.onSaveGameClick.bind(this)),this.gamePlay.addLoadGameListener(this.onLoadGameClick.bind(this))}onCellClick(t){if(!this.isBoardBlocked&&(null===this.gameState.selectedCell&&this.isOpponent(t)&&e.showError("Вы не можете выбрать противника!"),this.characterOnCell(t)&&this.isPlayer(t)&&(null!==this.gameState.selectedCell&&this.gamePlay.deselectCell(this.gameState.selectedCell),this.gamePlay.selectCell(t),this.gameState.selectedCell=t),null!==this.gameState.selectedCell)&&(this.isPlayer(t)||this.isCellForMovement(t)||this.isCellForAttack(t)||e.showError("Недопустимый действие!"),this.characterOnCell(t)||this.isCellForMovement(t)||!this.isCellForAttack(t)||e.showError("Недопустимый действие!"),this.isOpponent(t)&&this.isCellForMovement(t)&&!this.isCellForAttack(t)&&e.showError("Недопустимый действие!"),!this.characterOnCell(t)&&this.isCellForMovement(t)&&([...this.positionsOfPlayersTeam].find((e=>e.position===this.gameState.selectedCell)).position=t,this.gamePlay.deselectCell(this.gameState.selectedCell),this.gameState.selectedCell=t,this.gamePlay.selectCell(this.gameState.selectedCell),this.gamePlay.redrawPositions([...this.positionsOfPlayersTeam,...this.positionsOfOpponentsTeam]),this.opponentAttackOrMovement()),this.isOpponent(t)&&this.isCellForAttack(t))){const e=this.characterOnCell(this.gameState.selectedCell).character,s=this.characterOnCell(t).character,a=Math.max(e.attack-s.defence,.1*e.attack);(async()=>{await this.gamePlay.showDamage(t,a);const e=[...this.positionsOfOpponentsTeam].findIndex((e=>e.position===t)),s=this.positionsOfOpponentsTeam[e];s.character.health-=a,s.character.health<=0&&(this.gamePlay.deselectCell(s.position),this.opponentsTeam.splice(e,1),this.positionsOfOpponentsTeam.splice(e,1)),this.gamePlay.redrawPositions([...this.positionsOfPlayersTeam,...this.positionsOfOpponentsTeam]),this.opponentAttackOrMovement(),this.completionLevelOrGame()})()}}onCellEnter(e){if(!this.isBoardBlocked){if(this.characterOnCell(e)){this.gamePlay.setCursor(d);const s=`🎖${(t=this.characterOnCell(e).character).level} ⚔${t.attack} 🛡${t.defence} ❤${t.health}`;this.gamePlay.showCellTooltip(s,e)}var t;null!==this.gameState.selectedCell&&((this.isPlayer(e)||this.isCellForMovement(e)||this.isCellForAttack(e))&&(this.characterOnCell(e)||this.isCellForMovement(e)||!this.isCellForAttack(e))?this.isOpponent(e)&&this.isCellForMovement(e)&&!this.isCellForAttack(e)?this.gamePlay.setCursor(u):!this.characterOnCell(e)&&this.isCellForMovement(e)?(this.gamePlay.setCursor(d),this.gamePlay.selectCell(e,"green")):this.isOpponent(e)&&this.isCellForAttack(e)&&(this.gamePlay.setCursor(C),this.gamePlay.selectCell(e,"red")):this.gamePlay.setCursor(u))}}onCellLeave(e){this.gamePlay.setCursor(m),this.gamePlay.hideCellTooltip(e),e!==this.gameState.selectedCell&&this.gamePlay.deselectCell(e)}onNewGameClick(){this.gameState.level=1,this.gameState.selectedCell=null,this.isBoardBlocked=!1,this.gameState.maxPoints=Math.max(...this.pointsStatistics)===-1/0?0:Math.max(...this.pointsStatistics),this.pointsStatistics=[],this.playersTeam=p(this.playersTypes,1,2),this.opponentsTeam=p(this.opponentsTypes,1,2),this.positionsOfPlayersTeam=this.teamPositioning(this.playersTeam,this.playersInitialCellIndexes()),this.positionsOfOpponentsTeam=this.teamPositioning(this.opponentsTeam,this.opponentsInitialCellIndexes()),this.gamePlay.drawUi(f[this.gameState.level]),this.gamePlay.redrawPositions([...this.positionsOfPlayersTeam,...this.positionsOfOpponentsTeam]),e.showMessage("Новая игра!")}onSaveGameClick(){if(this.isBoardBlocked)return;const t={level:this.gameState.level,selectedCell:this.gameState.selectedCell,pointsStatistics:this.pointsStatistics,playersTeam:this.playersTeam,opponentsTeam:this.opponentsTeam,positionsOfPlayersTeam:this.positionsOfPlayersTeam,positionsOfOpponentsTeam:this.positionsOfOpponentsTeam};this.stateService.save(h.from(t)),e.showMessage("Игра успешно сохранена!")}onLoadGameClick(){this.isBoardBlocked=!1,this.playersTeam=[],this.opponentsTeam=[],this.positionsOfPlayersTeam=[],this.positionsOfOpponentsTeam=[];try{const t=this.stateService.load();this.gameState.level=t.level,this.gameState.selectedCell=t.selectedCell,this.pointsStatistics=t.pointsStatistics,t.positionsOfPlayersTeam.forEach((e=>{let t=null;"bowman"===e.character.type?(t=new s(e.character.level),this.playersTeam.push(t)):"swordsman"===e.character.type?(t=new a(e.character.level),this.playersTeam.push(t)):"magician"===e.character.type&&(t=new i(e.character.level),this.playersTeam.push(t)),t.attack=e.character.attack,t.defence=e.character.defence,t.health=e.character.health,this.positionsOfPlayersTeam.push(new r(t,e.position))})),t.positionsOfOpponentsTeam.forEach((e=>{let t=null;"vampire"===e.character.type?(t=new l(e.character.level),this.opponentsTeam.push(t)):"undead"===e.character.type?(t=new n(e.character.level),this.opponentsTeam.push(t)):"daemon"===e.character.type?(t=new o(e.character.level),this.opponentsTeam.push(t)):"bowman"===e.character.type&&(t=new s(e.character.level),this.opponentsTeam.push(t)),t.attack=e.character.attack,t.defence=e.character.defence,t.health=e.character.health,this.positionsOfOpponentsTeam.push(new r(t,e.position))})),this.gamePlay.drawUi(f[this.gameState.level]),this.gamePlay.redrawPositions([...this.positionsOfPlayersTeam,...this.positionsOfOpponentsTeam]),this.gamePlay.selectCell(this.gameState.selectedCell),e.showMessage("Игра загружена!")}catch(t){e.showMessage("Игру загрузить не удаётся :("),console.log(t)}}opponentAttackOrMovement(e=!0){if(0===this.positionsOfPlayersTeam||0===this.positionsOfOpponentsTeam.length)return;let t=null,s=null;for(const e of[...this.positionsOfOpponentsTeam]){const a=this.distanceCalculation(e.character.attackDistance,e.position);[...this.positionsOfPlayersTeam].forEach((i=>{a.includes(i.position)&&(t=e,s=i)}))}const a=[...this.positionsOfPlayersTeam,...this.positionsOfOpponentsTeam];if(!s&&e){const e=Math.floor(Math.random()*[...this.positionsOfOpponentsTeam].length);t=[...this.positionsOfOpponentsTeam][e];const s=this.distanceCalculation(t.character.movementDistance,t.position);for(const e of s)a.forEach((t=>{e===t.position&&s.splice(s.indexOf(t.position),1)}));this.gamePlay.deselectCell(t.position);const i=s[Math.floor(Math.random()*s.length)];this.positionsOfOpponentsTeam[e].position=i,this.gamePlay.redrawPositions([...this.positionsOfPlayersTeam,...this.positionsOfOpponentsTeam])}else if(s){const e=Math.max(t.character.attack-s.character.defence,.1*t.character.attack);(async()=>{await this.gamePlay.showDamage(s.position,e),s.character.health-=e,s.character.health<=0&&(s.position===this.gameState.selectedCell&&(this.gamePlay.deselectCell(t.position),this.gamePlay.deselectCell(this.gameState.selectedCell),this.gameState.selectedCell=null),this.playersTeam.splice(this.playersTeam.indexOf(s.character),1),this.positionsOfPlayersTeam.splice(this.positionsOfPlayersTeam.indexOf(s),1)),this.gamePlay.redrawPositions([...this.positionsOfPlayersTeam,...this.positionsOfOpponentsTeam]),this.completionLevelOrGame()})()}}completionLevelOrGame(){if(0===this.positionsOfOpponentsTeam.length){this.gamePlay.deselectCell(this.gameState.selectedCell),this.gameState.selectedCell=null;const t=this.pointsForCompletedLevel();if(this.pointsStatistics.push(t),this.gameState.level<4){this.gameState.level++,this.playersTeam.forEach((e=>e.levelUp()));const s=[...this.playersTeam];this.playersTeam=[...p(this.playersTypes,this.gameState.level,1),...s],this.opponentsTeam=p(this.opponentsTypes,this.gameState.level,this.playersTeam.length),this.positionsOfPlayersTeam=this.teamPositioning(this.playersTeam,this.playersInitialCellIndexes()),this.positionsOfOpponentsTeam=this.teamPositioning(this.opponentsTeam,this.opponentsInitialCellIndexes()),this.gamePlay.drawUi(f[this.gameState.level]),this.gamePlay.redrawPositions([...this.positionsOfPlayersTeam,...this.positionsOfOpponentsTeam]),e.showMessage(`Новый ${this.gameState.level} уровень игры!\nКоличество баллов за пройденный ${this.gameState.level-1} уровень: ${t}`)}else 4===this.gameState.level&&(this.isBoardBlocked=!0,e.showMessage(`ПОБЕДА!\nКоличество баллов за пройденный ${this.gameState.level} уровень: ${t}\nМаксимальное количество баллов: ${Math.max(...this.pointsStatistics)}\nИтоговое количество баллов: ${this.pointsStatistics.reduce(((e,t)=>e+t),0)}`))}else if(0===this.positionsOfPlayersTeam.length){this.isBoardBlocked=!0;const t=Math.max(...this.pointsStatistics)===-1/0?0:Math.max(...this.pointsStatistics);e.showMessage(`ПОРАЖЕНИЕ!\nМаксимальное количество баллов: ${t}\nИтоговое количество баллов: ${this.pointsStatistics.reduce(((e,t)=>e+t),0)}`)}}pointsForCompletedLevel(){return this.positionsOfPlayersTeam.reduce(((e,t)=>e+t.character.health),0)}characterOnCell(e){return[...this.positionsOfPlayersTeam,...this.positionsOfOpponentsTeam].find((t=>t.position===e))}isPlayer(e){return[...this.positionsOfPlayersTeam].some((t=>t.position===e))}isOpponent(e){return[...this.positionsOfOpponentsTeam].some((t=>t.position===e))}isCellForMovement(e){if(null===this.gameState.selectedCell)return!1;const t=this.characterOnCell(this.gameState.selectedCell).character;return this.distanceCalculation(t.movementDistance,this.gameState.selectedCell).includes(e)}isCellForAttack(e){if(null===this.gameState.selectedCell)return!1;const t=this.characterOnCell(this.gameState.selectedCell).character;return this.distanceCalculation(t.attackDistance,this.gameState.selectedCell).includes(e)}playersInitialCellIndexes(){const e=[],t=this.gamePlay.boardSize;for(let s=0;s<t**2;s+=t)e.push(s),e.push(s+1);return e}opponentsInitialCellIndexes(){const e=[],t=this.gamePlay.boardSize;for(let s=t-1;s<t**2;s+=t)e.push(s),e.push(s-1);return e}teamPositioning(e,t){const s=[...t],a=[];return e.forEach((e=>{const t=Math.floor(Math.random()*s.length);a.push(new r(e,s[t])),s.splice(t,1)})),a}distanceCalculation(e,t){const s=this.gamePlay.boardSize;if(t>=s**2)throw new Error("Unknown character cell index");const a=Math.trunc(t/s),i=t%s,l=[];for(let t=1;t<=e;t++){const e=a-t,s=a+t,n=i-t,o=i+t;e>=0&&l.push(8*e+i),s<=7&&l.push(8*s+i),n>=0&&l.push(8*a+n),o<=7&&l.push(8*a+o),e>=0&&n>=0&&l.push(8*e+n),e>=0&&o<=7&&l.push(8*e+o),s<=7&&n>=0&&l.push(8*s+n),s<=7&&o<=7&&l.push(8*s+o)}return l}}(y,g);v.init()})();